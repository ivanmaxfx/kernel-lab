name: Kernel Module CI

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # 0. Checkout repository
      # ---------------------------
      - name: Checkout repo
        uses: actions/checkout@v3

      # ---------------------------
      # 1. Install dependencies
      # ---------------------------
      - name: Install tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # ---------------------------
      # 2. Build Docker image
      # ---------------------------
      - name: Build kernel lab Docker image
        run: |
          docker build -t kernel-lab .

      # ---------------------------
      # 3. Run QEMU inside container
      # ---------------------------
      - name: Run kernel tests in QEMU
        run: |
          # Запускаем и логируем всё в файл
          docker run --privileged --rm kernel-lab | tee qemu_output.txt

      # ---------------------------
      # 4. Extract JSON from QEMU output
      # ---------------------------
      - name: Extract JSON and validate
        run: |
          RAW_OUTPUT="$(cat qemu_output.txt)"

          echo "=== RAW OUTPUT ==="
          echo "$RAW_OUTPUT"

          JSON=$(echo "$RAW_OUTPUT" | sed -n '/===RESULT===/{n;/===END===/q;p;}')

          echo "=== PARSED JSON ==="
          echo "$JSON"

          STATUS=$(echo "$JSON" | jq -r '.status')

          if [[ "$STATUS" != "ok" ]]; then
              echo "❌ Module failed to load"
              exit 1
          fi

          # Проверка hello НЕ через JSON!!
          if ! echo "$RAW_OUTPUT" | grep -q "Hello from kernel module"; then
              echo "❌ Module loaded but did NOT print hello"
              exit 1
          fi

          echo "✅ Module printed hello and loaded OK"
